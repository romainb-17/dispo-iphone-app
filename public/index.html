<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Stock explorer </title>
  <link rel="stylesheet" href="/styles.css?v=1">
  <meta name="color-scheme" content="light dark">
  <script>
    // Applique le thème avant paint (évite flash)
    (function(){
      const saved = localStorage.getItem('theme'); // 'light' | 'dark' | null (auto)
      if(saved==='light' || saved==='dark'){ document.documentElement.setAttribute('data-theme', saved); }
      // sinon, on laisse le media-query décider (auto)
    })();
  </script>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand">
        <h1 style="margin:0;font-size:20px">📦 Dispo iPhone</h1>
        <span class="badge">FR ZD/A</span>
      </div>
      <div class="toolbar">
        <button id="themeToggle" class="theme-btn" aria-label="Basculer thème">
          <svg class="theme-icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 3a1 1 0 0 1 1 1v1.05a7 7 0 1 1-2 0V4a1 1 0 0 1 1-1zM4 13H3a1 1 0 1 1 0-2h1a1 1 0 1 1 0 2zm17 0h-1a1 1 0 1 1 0-2h1a1 1 0 1 1 0 2zM6.22 6.22a1 1 0 0 1 1.42 0l.74.74a1 1 0 1 1-1.42 1.42l-.74-.74a1 1 0 0 1 0-1.42zM15.62 15.62a1 1 0 0 1 1.42 0l.74.74a1 1 0 1 1-1.42 1.42l-.74-.74a1 1 0 0 1 0-1.42z"/>
          </svg>
          <span id="themeLabel">Auto</span>
        </button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>Modèle</label><br/>
          <select id="model"><option value="">— choisir —</option></select>
        </div>
        <div>
          <label>Couleur</label><br/>
          <select id="color" disabled><option value="">— choisir —</option></select>
        </div>
        <div>
          <label>Capacité</label><br/>
          <select id="capacity" disabled><option value="">— choisir —</option></select>
        </div>
        <div style="align-self:end" class="muted">SKU : <span id="sku" class="sku">(aucun)</span></div>
      </div>

      <div class="row">
        <div>
          <label>Pays</label><br/>
          <select id="country"><option>fr</option><option>be</option><option>ch</option><option>es</option><option>de</option><option>uk</option><option>us</option></select>
        </div>
        <div>
          <label>Localisation (CP/ville ou lat,long)</label><br/>
          <input id="location" placeholder="17000 ou 48.85,2.35" value="17000"/>
        </div>
        <div>
          <label>Store RXXX (optionnel)</label><br/>
          <input id="store" placeholder="R123" style="min-width:100px"/>
        </div>
        <div style="align-self:end">
          <button id="go" class="btn-primary">Rechercher</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead><tr><th>Store</th><th>Ville</th><th>Distance</th><th>Modèle · Couleur · Capacité</th><th>Dispo</th><th>Quote</th></tr></thead>
          <tbody id="tbody"><tr><td colspan="6" class="muted">Sélectionne un modèle puis “Rechercher”.</td></tr></tbody>
        </table>
      </div>

      
<section id="eventsSection" class="card" style="margin-top:16px">
  <div class="row" style="justify-content:space-between;align-items:center;margin:0 0 8px">
    <h2 style="margin:0;font-size:16px">🕒 Derniers événements (50)</h2>
    <button id="eventsRefresh">Rafraîchir</button>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Date/heure</th><th>Store</th><th>Ville</th><th>Modèle · Couleur · Capacité</th><th>Changement</th><th>Quote</th></tr>
      </thead>
      <tbody id="eventsBody"><tr><td colspan="6" class="muted">Chargement…</td></tr></tbody>
    </table>
  </div>
  <p class="muted">Actualisation automatique chaque minute.</p>
</section>

<footer style="margin-top:16px;text-align:center"><a href="https://amzn.to/47Kt0VX" target="_blank" rel="nofollow sponsored noopener" style="font-size:20px;line-height:1.2;font-weight:600">Achète un iPhone sur Amazon</a></footer>
    </div>
  </div>

  <script>
    // Bouton thème : Auto → Sombre → Clair (cycle)
    (function(){
      const btn = document.getElementById('themeToggle');
      const label = document.getElementById('themeLabel');
      function getMode(){
        const v = document.documentElement.getAttribute('data-theme');
        return v === 'dark' ? 'dark' : v === 'light' ? 'light' : 'auto';
      }
      function setMode(mode){
        if(mode==='auto'){ document.documentElement.removeAttribute('data-theme'); localStorage.removeItem('theme'); label.textContent='Auto'; }
        if(mode==='dark'){ document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('theme','dark'); label.textContent='Sombre'; }
        if(mode==='light'){ document.documentElement.setAttribute('data-theme','light'); localStorage.setItem('theme','light'); label.textContent='Clair'; }
        // meta theme-color pour mobile barre d'adresse
        const mc = document.querySelector('meta[name="theme-color"]') || (function(){ const m=document.createElement('meta'); m.name='theme-color'; document.head.appendChild(m); return m; })();
        const isDark = getMode()==='dark' || (getMode()==='auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        mc.setAttribute('content', isDark ? '#0b0f19' : '#fafafa');
      }
      btn.addEventListener('click', ()=>{
        const order = ['auto','dark','light'];
        const next = order[(order.indexOf(getMode())+1)%order.length];
        setMode(next);
      });
      setMode(getMode()); // init
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{ if(getMode()==='auto') setMode('auto'); });
    })();
  </script>

  <script src="/app.js" type="module"></script>
  <script defer src="/js/manual-table-fix.js?v=1756646643"></script>
  <script id="SKU_LABEL_PATCH">
(() => {
  const DATA_URL = '/data/apple_fr_skus.json?v=1756643981';
  function buildMap(d){
    const map={}; if(!d) return map;
    if(Array.isArray(d)){
      for(const it of d){const lab=` ·  · `; (it.partNumber||[]).forEach(p=>p&&(map[String(p).trim()]=lab));}
    } else if(typeof d==='object'){
      for(const m of Object.keys(d)){const colors=d[m]||{}; for(const c of Object.keys(colors)){const caps=colors[c]||{}; for(const cap of Object.keys(caps)){const pn=caps[cap]; if(Array.isArray(pn)) pn.forEach(p=>p&&(map[String(p).trim()]=` ·  · `)); else if(pn) map[String(pn).trim()]=` ·  · `;}}}
    }
    return map;
  }
  function looksLikeSku(s){return !!String(s||'').trim().match(/^[A-Z0-9]{4,}/[A-Z0-9]i);} 
  function findSkuColIndex(table){
    const ths=table.querySelectorAll('thead th');
    for(let i=0;i<ths.length;i++){const t=ths[i].textContent.trim().toLowerCase(); if(['sku','référence','reference','modèle · couleur · capacité'].includes(t)) return i;}
    return 3; // fallback 4e colonne: Store, Ville, Distance, SKU, ...
  }
  async function loadMap(){try{const r=await fetch(DATA_URL,{cache:'no-store'}); const j=await r.json(); return buildMap(j);}catch(e){console.warn('[SKU_LABEL_PATCH] JSON KO', e); return {};}}
  async function patchTable(table, map){
    const idx=findSkuColIndex(table);
    for(const tr of table.querySelectorAll('tbody tr')){
      const tds=tr.querySelectorAll('td'); if(!tds[idx]) continue; const cell=tds[idx];
      let raw=(cell.getAttribute('data-raw')||cell.textContent||'').trim();
      if(!looksLikeSku(raw)){const m=cell.textContent.match(/[A-Z0-9]{4,}/[A-Z0-9]/i); if(m) raw=m[0];}
      if(!looksLikeSku(raw)) continue; const label=map[raw]; if(!label) continue;
      cell.setAttribute('data-raw', raw); cell.title = `SKU: `; cell.textContent = label;
    }
  }
  async function run(root=document){ const map=await loadMap(); const tables=root.querySelectorAll('table'); for(const t of tables) await patchTable(t,map); }
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',()=>run());} else { run(); }
  const mo=new MutationObserver(muts=>{ for(const m of muts){ for(const n of m.addedNodes||[]){ if(n.nodeType===1) run(n); } }});
  mo.observe(document.documentElement,{childList:true, subtree:true});
})();
</script>
  <script id="SKU_INLINE_MAP">
(() => {
  // Mini mapping immédiat (ajoute tes SKUs ici)
  const MAP = {
    "MYND3ZD/A": "iPhone 16 Pro · Titane Noir · 128 Go",
  };
  function looksSku(s){return /^[A-Z0-9]{4,}\/[A-Z0-9]i.test(String(s||"").trim());}
  function fix(root=document){
    const tables = root.querySelectorAll("table");
    tables.forEach(t => {
      // 4e colonne: Store | Ville | Distance | SKU | ...
      t.querySelectorAll("tbody tr, tr").forEach(tr => {
        const tds = tr.querySelectorAll("td");
        if (!tds[3]) return;
        let raw = (tds[3].getAttribute("data-raw") || tds[3].textContent || "").trim();
        if (!looksSku(raw)) {
          const m = tds[3].textContent.match(/[A-Z0-9]{4,}\/[A-Z0-9]/i); if (m) raw = m[0];
        }
        const label = MAP[raw];
        if (label) { tds[3].setAttribute("data-raw", raw); tds[3].title = `SKU: `; tds[3].textContent = label; }
      });
    });
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", fix); else fix();
  new MutationObserver(m=>m.forEach(x=>x.addedNodes&&x.addedNodes.forEach(n=>n.nodeType===1&&fix(n)))).observe(document.documentElement,{childList:true,subtree:true});
})();
</script>
  <script defer src="/js/manual-dispo-translate.js?v=1756646303"></script>
  <script src="/sku-table-labels.js?v=1756647289" defer></script>
</body>
</html>
